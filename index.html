<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Расшифровка VIN</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- PDF (кириллица ок) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.min.js"></script>

  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #111111);
      --hint: var(--tg-theme-hint-color, #6b7280);
      --card: var(--tg-theme-secondary-bg-color, #f3f4f6);
      --border: rgba(0,0,0,.10);
      --accent: var(--tg-theme-button-color, #2ea6ff);
      --accentText: var(--tg-theme-button-text-color, #ffffff);
    }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row input{flex:1;min-width:240px}
    input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:transparent;color:var(--text);outline:none}
    input:focus{border-color:rgba(46,166,255,.7)}
    button{padding:12px 14px;border:0;border-radius:12px;font-size:16px;cursor:pointer;background:var(--accent);color:var(--accentText);font-weight:600;white-space:nowrap}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{margin-top:10px;color:var(--hint);font-size:12px}
    .error{color:#ef4444;margin-top:10px;font-size:13px;display:none}
    .ok{color:#16a34a;margin-top:10px;font-size:13px;display:none}
    .grid{margin-top:14px;display:grid;gap:12px;grid-template-columns:1fr;align-items:start}
    @media (min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .topline{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:rgba(255,255,255,.35)}
    .badge.ok{border-color:rgba(34,197,94,.35)}
    .badge.warn{border-color:rgba(245,158,11,.45)}
    .kv{margin-top:12px;width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    .kv td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;font-size:14px}
    .kv tr:last-child td{border-bottom:0}
    .k{color:var(--hint);width:220px}
    .mono{white-space:pre-wrap;word-break:break-word;background:rgba(255,255,255,.55);border:1px solid var(--border);padding:10px;border-radius:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;margin-top:8px}
    .pdfBox{display:none}
    .pdfTitle{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    iframe{width:100%;height:520px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .muted{color:var(--hint)}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Расшифровка VIN</h1>

    <div class="row">
      <input id="vin" placeholder="Введите VIN (17 символов)" maxlength="17" autocomplete="off" />
      <button id="btn">Проверить</button>
      <button id="subBtn" class="secondary" style="display:none;">Подписаться</button>
      <button id="recheckBtn" class="secondary" style="display:none;">Я подписался — проверить</button>
    </div>

    <div class="hint">Перед показом данных нужна подписка на канал: @avtobazapro</div>

    <div id="msg" class="error"></div>
    <div id="okmsg" class="ok"></div>

    <div class="grid" id="grid" style="display:none;">
      <div class="card">
        <div class="topline">
          <div>
            <div style="font-weight:700;font-size:16px" id="title">—</div>
            <div class="muted" style="margin-top:2px" id="subtitle">—</div>
          </div>
          <div class="badge warn" id="badge">—</div>
        </div>

        <table class="kv" id="table"></table>

        <details style="margin-top:10px;">
          <summary class="muted" style="cursor:pointer;">Подробности (все поля)</summary>
          <div class="mono" id="details">—</div>
        </details>
      </div>

      <div class="card pdfBox" id="pdfBox">
        <div class="pdfTitle">
          <div>
            <div style="font-weight:700;">PDF</div>
            <div class="muted" style="font-size:12px;">Можно скачать или открыть</div>
          </div>
          <div class="row" style="gap:8px;margin:0;">
            <button class="secondary" id="openPdfBtn" disabled>Открыть</button>
            <button id="downloadPdfBtn" disabled>Скачать PDF</button>
          </div>
        </div>
        <iframe id="pdfFrame" title="PDF preview"></iframe>
      </div>
    </div>
  </div>

  <script>
    // === ВАЖНО: сюда вставь URL твоего Cloudflare Worker ===
    // Пример: const ACCESS_API = "https://vin-access.yourname.workers.dev";
    const ACCESS_API = "https://vin-access.nikolay-nee.workers.dev/";

    const CHANNEL_LINK = "https://t.me/avtobazapro";

    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand();

    const vinEl = document.getElementById('vin');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const okmsg = document.getElementById('okmsg');

    const subBtn = document.getElementById('subBtn');
    const recheckBtn = document.getElementById('recheckBtn');

    const grid = document.getElementById('grid');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const badgeEl = document.getElementById('badge');
    const tableEl = document.getElementById('table');
    const detailsEl = document.getElementById('details');

    const pdfBox = document.getElementById('pdfBox');
    const pdfFrame = document.getElementById('pdfFrame');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const openPdfBtn = document.getElementById('openPdfBtn');

    const vinRe = /^[A-HJ-NPR-Z0-9]{17}$/;
    let lastPdfBlobUrl = null;
    let lastPdfFileName = null;

    function showError(text){
      msg.style.display = text ? 'block' : 'none';
      msg.textContent = text || '';
      okmsg.style.display = 'none';
    }
    function showOk(text){
      okmsg.style.display = text ? 'block' : 'none';
      okmsg.textContent = text || '';
      msg.style.display = 'none';
    }
    function setLoading(isLoading){
      btn.disabled = isLoading;
      btn.textContent = isLoading ? 'Проверяю…' : 'Проверить';
    }
    function cleanVin(v){ return (v || '').trim().toUpperCase().replace(/\s+/g,''); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function row(label, value){
      if (!value || value === "Not Applicable") return '';
      return `<tr><td class="k">${label}</td><td>${escapeHtml(String(value))}</td></tr>`;
    }

    async function checkSubscription(){
      if (!tg?.initData) {
        // Если открыли не внутри Telegram
        return { ok:false, member:false, error:"Откройте мини-приложение внутри Telegram." };
      }
      if (!ACCESS_API || ACCESS_API.includes("PASTE_YOUR_WORKER_URL_HERE")) {
        return { ok:false, member:false, error:"Не задан ACCESS_API (URL Worker)." };
      }
      const r = await fetch(ACCESS_API, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ initData: tg.initData })
      });
      return await r.json();
    }

    function showSubscribeUI(show){
      subBtn.style.display = show ? 'inline-block' : 'none';
      recheckBtn.style.display = show ? 'inline-block' : 'none';
    }

    subBtn.onclick = () => {
      if (tg?.openTelegramLink) tg.openTelegramLink(CHANNEL_LINK);
      else window.open(CHANNEL_LINK, "_blank");
    };

    recheckBtn.onclick = async () => {
      showError('');
      const s = await checkSubscription();
      if (s.ok && s.member) {
        showSubscribeUI(false);
        showOk("Подписка подтверждена ✅ Теперь можно проверять VIN.");
      } else {
        showSubscribeUI(true);
        showError("Подписка не найдена. Подпишись на канал и нажми «Я подписался — проверить».");
      }
    };

    async function fetchValuesExtended(vin){
      const url = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${vin}?format=json`;
      const r = await fetch(url);
      const j = await r.json();
      return (j.Results && j.Results[0]) ? j.Results[0] : null;
    }

    function statusFromErrorCode(code){
      if (!code) return {cls:'warn', text:'Данные частичные'};
      const c = String(code).trim();
      if (c === '0') return {cls:'ok', text:'VIN распознан'};
      return {cls:'warn', text:`Есть предупреждения (${c})`};
    }

    function normalize(vin, x){
      return {
        VIN: vin,
        Make: x?.Make || null,
        Model: x?.Model || null,
        ModelYear: x?.ModelYear || null,
        VehicleType: x?.VehicleType || null,
        BodyClass: x?.BodyClass || null,
        EngineModel: x?.EngineModel || null,
        EngineDisplacementL: x?.DisplacementL || x?.EngineDisplacementL || null,
        TransmissionStyle: x?.TransmissionStyle || null,
        PlantCountry: x?.PlantCountry || null,
        PlantCompanyName: x?.PlantCompanyName || null,
        ErrorCode: x?.ErrorCode || null,
        ErrorText: x?.ErrorText || null,
        SuggestedVIN: x?.SuggestedVIN || null,
        PossibleValues: x?.PossibleValues || null,
        AdditionalErrorText: x?.AdditionalErrorText || null
      };
    }

    function render(data){
      const make = data.Make || '—';
      const model = data.Model || '';
      const year = data.ModelYear || '';
      titleEl.textContent = [make, model].filter(Boolean).join(' ') || make;
      subtitleEl.textContent = [year, data.VehicleType].filter(Boolean).join(' • ') || '—';

      const st = statusFromErrorCode(data.ErrorCode);
      badgeEl.className = `badge ${st.cls}`;
      badgeEl.textContent = st.text;

      const engine = data.EngineModel || data.EngineDisplacementL || null;

      tableEl.innerHTML =
        row('VIN', data.VIN) +
        row('Марка', data.Make) +
        row('Модель', data.Model) +
        row('Год', data.ModelYear) +
        row('Тип ТС', data.VehicleType) +
        row('Кузов', data.BodyClass) +
        row('Двигатель', engine) +
        row('Коробка', data.TransmissionStyle) +
        row('Страна сборки', data.PlantCountry) +
        row('Завод', data.PlantCompanyName) +
        row('Предупреждение', data.ErrorText) +
        row('Suggested VIN', data.SuggestedVIN) +
        row('Possible values', data.PossibleValues);

      detailsEl.textContent = JSON.stringify(data, null, 2);
      grid.style.display = 'grid';
    }

    function buildPdf(data){
      if (lastPdfBlobUrl) URL.revokeObjectURL(lastPdfBlobUrl);
      lastPdfBlobUrl = null;
      lastPdfFileName = `VIN_${data.VIN}.pdf`;

      const lines = [
        ['VIN', data.VIN],
        ['Марка', data.Make],
        ['Модель', data.Model],
        ['Год', data.ModelYear],
        ['Тип ТС', data.VehicleType],
        ['Кузов', data.BodyClass],
        ['Двигатель', data.EngineModel || data.EngineDisplacementL],
        ['Коробка', data.TransmissionStyle],
        ['Страна сборки', data.PlantCountry],
        ['Завод', data.PlantCompanyName],
        ['Предупреждение', data.ErrorText],
        ['Suggested VIN', data.SuggestedVIN],
        ['Possible values', data.PossibleValues],
      ].filter(([_, v]) => v && v !== 'Not Applicable');

      const docDefinition = {
        content: [
          { text: 'Расшифровка VIN', style: 'h1' },
          { text: 'Источник: NHTSA vPIC', style: 'muted' },
          { text: ' ', margin: [0, 6, 0, 6] },
          {
            table: {
              widths: [160, '*'],
              body: lines.map(([k, v]) => ([ {text: String(k), style:'k'}, {text: String(v)} ]))
            },
            layout: 'lightHorizontalLines'
          },
          { text: ' ', margin: [0, 6, 0, 6] },
          { text: `Статус: ${statusFromErrorCode(data.ErrorCode).text}`, style: 'muted' }
        ],
        styles: {
          h1: { fontSize: 16, bold: true },
          muted: { fontSize: 10, color: '#666666' },
          k: { fontSize: 11, color: '#666666' }
        },
        defaultStyle: { fontSize: 11 }
      };

      pdfMake.createPdf(docDefinition).getBlob((blob) => {
        lastPdfBlobUrl = URL.createObjectURL(blob);
        pdfFrame.src = lastPdfBlobUrl;

        pdfBox.style.display = 'block';
        downloadPdfBtn.disabled = false;
        openPdfBtn.disabled = false;
      });
    }

    downloadPdfBtn.onclick = () => {
      if (!lastPdfBlobUrl) return;
      const a = document.createElement('a');
      a.href = lastPdfBlobUrl;
      a.download = lastPdfFileName || 'vin.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
    openPdfBtn.onclick = () => {
      if (!lastPdfBlobUrl) return;
      if (tg?.openLink) tg.openLink(lastPdfBlobUrl);
      else window.open(lastPdfBlobUrl, '_blank');
    };

    async function onSearch(){
      showError('');
      showOk('');
      grid.style.display = 'none';
      pdfBox.style.display = 'none';
      downloadPdfBtn.disabled = true;
      openPdfBtn.disabled = true;

      const vin = cleanVin(vinEl.value);
      vinEl.value = vin;

      if (!vinRe.test(vin)){
        showError('VIN должен быть 17 символов (без I, O, Q).');
        return;
      }

      setLoading(true);

      try{
        // 1) Проверяем подписку
        const s = await checkSubscription();
        if (!(s.ok && s.member)) {
          showSubscribeUI(true);
          showError("Чтобы увидеть данные, нужно быть подписчиком @avtobazapro. Нажми «Подписаться», затем «Я подписался — проверить».");
          return;
        }
        showSubscribeUI(false);

        // 2) Тянем данные по VIN
        const raw = await fetchValuesExtended(vin);
        const data = normalize(vin, raw);
        render(data);
        buildPdf(data);
      } catch (e){
        showError('Ошибка. Проверь ACCESS_API (Worker URL) и что бот админ в канале.');
        console.error(e);
      } finally {
        setLoading(false);
      }
    }

    btn.addEventListener('click', onSearch);
    vinEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') onSearch(); });
  </script>
</body>
</html>
